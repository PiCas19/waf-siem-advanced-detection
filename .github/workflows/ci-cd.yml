name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev, feature/* ]
  pull_request:
    branches: [ main, dev ]
  release:
    types: [ created ]

env:
  GO_VERSION: '1.25'
  NODE_VERSION: '20'
  TZ: 'Europe/Zurich'

jobs:
  # ============================================
  # STAGE 1: INSTALL & LINT
  # ============================================
  install-and-lint:
    name: Install Dependencies & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          echo "Timezone set to: $(date)"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: |
            api/go.sum
            waf/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Tidy Go modules (API)
        working-directory: ./api
        run: |
          go mod tidy
          go mod verify

      - name: Tidy Go modules (WAF)
        working-directory: ./waf
        run: |
          go mod tidy
          go mod verify

      - name: Install Go dependencies (API)
        working-directory: ./api
        run: |
          go mod download
          go mod verify

      - name: Install Go dependencies (WAF)
        working-directory: ./waf
        run: |
          go mod download
          go mod verify

      - name: Check and create package-lock.json if missing
        working-directory: ./dashboard
        run: |
          if [ ! -f "package-lock.json" ]; then
            echo "package-lock.json not found, generating..."
            npm install --package-lock-only --no-audit
            echo "package-lock.json generated successfully"
          else
            echo "package-lock.json found, proceeding with npm ci"
          fi

      - name: Install Node.js dependencies (Dashboard)
        working-directory: ./dashboard
        run: npm ci

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('dashboard/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Lint Dashboard
        working-directory: ./dashboard
        run: npm run lint

  # ============================================
  # STAGE 2: TESTS
  # ============================================
  test-api:
    name: Test API
    runs-on: ubuntu-latest
    needs: install-and-lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          echo "Current time: $(date)"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: api/go.sum

      - name: Tidy Go modules
        working-directory: ./api
        run: go mod tidy

      - name: Install dependencies
        working-directory: ./api
        run: go mod download

      # CORRETTO: Usa lo stesso comando che funziona localmente
      - name: Run API tests with coverage
        working-directory: ./api
        run: |
          # Primo test per verificare la struttura
          echo "Testing structure..."
          find . -name "*_test.go" -type f | head -5
          
          # Esegui i test con il comando che funziona localmente
          go test -coverprofile=coverage.out ./... -v
          
          # Verifica che coverage.out sia stato creato
          if [ -f "coverage.out" ]; then
            echo "Coverage file created successfully"
          else
            echo "Creating minimal coverage file..."
            echo "mode: atomic" > coverage.out
          fi

      - name: Generate coverage report
        working-directory: ./api
        run: |
          if [ -f "coverage.out" ] && [ -s "coverage.out" ]; then
            go tool cover -html=coverage.out -o coverage.html
            echo "Coverage report generated"
          else
            echo "No coverage data available"
            echo "<html><body><h1>No coverage data</h1></body></html>" > coverage.html
          fi

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: api-coverage
          path: api/coverage.html
          retention-days: 7

  test-waf:
    name: Test WAF
    runs-on: ubuntu-latest
    needs: install-and-lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          echo "Current time: $(date)"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: waf/go.sum

      - name: Tidy Go modules
        working-directory: ./waf
        run: go mod tidy

      - name: Install dependencies
        working-directory: ./waf
        run: go mod download

      # CORRETTO: Usa lo stesso comando che funziona localmente
      - name: Run WAF tests with coverage
        working-directory: ./waf
        run: |
          # Esegui i test con il comando che funziona localmente
          go test -coverprofile=coverage.out ./... -v
          
          # Verifica che coverage.out sia stato creato
          if [ -f "coverage.out" ]; then
            echo "Coverage file created successfully"
          else
            echo "Creating minimal coverage file..."
            echo "mode: atomic" > coverage.out
          fi

      - name: Generate coverage report
        working-directory: ./waf
        run: |
          if [ -f "coverage.out" ] && [ -s "coverage.out" ]; then
            go tool cover -html=coverage.out -o coverage.html
            echo "Coverage report generated"
          else
            echo "No coverage data available"
            echo "<html><body><h1>No coverage data</h1></body></html>" > coverage.html
          fi

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: waf-coverage
          path: waf/coverage.html
          retention-days: 7

  test-dashboard:
    name: Test Dashboard
    runs-on: ubuntu-latest
    needs: install-and-lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          echo "Current time: $(date)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('dashboard/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Check package-lock.json
        working-directory: ./dashboard
        run: |
          if [ ! -f "package-lock.json" ]; then
            echo "Generating package-lock.json..."
            npm install --package-lock-only --no-audit
          fi

      - name: Install dependencies
        working-directory: ./dashboard
        run: npm ci

      - name: Run unit tests
        working-directory: ./dashboard
        env:
          TZ: Europe/Zurich
          NODE_TZ: Europe/Zurich
        run: npm run test:run

      - name: Generate coverage
        working-directory: ./dashboard
        env:
          TZ: Europe/Zurich
          NODE_TZ: Europe/Zurich
        run: npm run test:coverage

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-coverage
          path: dashboard/coverage/
          retention-days: 7

  test-dashboard-e2e:
    name: Test Dashboard E2E (Cypress)
    runs-on: ubuntu-latest
    needs: install-and-lint
    # Usa container Docker per Cypress per evitare problemi di dipendenze
    container:
      image: cypress/included:12.0.0

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" > /etc/timezone
          echo "Current time: $(date)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check package-lock.json
        working-directory: ./dashboard
        run: |
          if [ ! -f "package-lock.json" ]; then
            echo "Generating package-lock.json..."
            npm install --package-lock-only --no-audit
          fi

      - name: Install dependencies
        working-directory: ./dashboard
        run: npm ci

      # Cypress è già incluso nell'immagine Docker
      - name: Run Cypress E2E tests
        working-directory: ./dashboard
        env:
          TZ: Europe/Zurich
          NODE_TZ: Europe/Zurich
          CYPRESS_baseUrl: http://localhost:3000
        run: |
          # Verifica se Cypress è disponibile
          npx cypress --version
          
          # Prova diversi approcci
          if grep -q '"test:e2e"' package.json; then
            echo "Running npm test:e2e..."
            npm run test:e2e
          elif grep -q '"cypress:run"' package.json; then
            echo "Running npm cypress:run..."
            npm run cypress:run
          else
            echo "Running default Cypress command..."
            npx cypress run --browser electron
          fi

      - name: Upload Cypress artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            dashboard/cypress/videos
            dashboard/cypress/screenshots
          if-no-files-found: ignore
          retention-days: 7

  # ============================================
  # STAGE 3: BUILD
  # ============================================
  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: [test-api]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: api/go.sum

      - name: Tidy Go modules
        working-directory: ./api
        run: go mod tidy

      - name: Install dependencies
        working-directory: ./api
        run: go mod download

      - name: Build API server
        working-directory: ./api
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o bin/api-server-linux-amd64 ./cmd/api-server
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o bin/api-server-darwin-amd64 ./cmd/api-server
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o bin/api-server-darwin-arm64 ./cmd/api-server
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o bin/api-server-windows-amd64.exe ./cmd/api-server

      - name: Upload API binaries
        uses: actions/upload-artifact@v4
        with:
          name: api-binaries
          path: api/bin/
          retention-days: 7

  build-waf:
    name: Build WAF
    runs-on: ubuntu-latest
    needs: [test-waf]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: waf/go.sum

      - name: Tidy Go modules
        working-directory: ./waf
        run: go mod tidy

      - name: Install dependencies
        working-directory: ./waf
        run: go mod download

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      - name: Build Caddy with WAF plugin
        working-directory: ./waf
        run: |
          mkdir -p bin
          xcaddy build --output bin/caddy-waf-linux-amd64
          GOOS=darwin GOARCH=amd64 xcaddy build --output bin/caddy-waf-darwin-amd64
          GOOS=darwin GOARCH=arm64 xcaddy build --output bin/caddy-waf-darwin-arm64
          GOOS=windows GOARCH=amd64 xcaddy build --output bin/caddy-waf-windows-amd64.exe

      - name: Build Coraza Forwarder
        working-directory: ./waf
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o bin/coraza-forwarder-linux-amd64 ./cmd/coraza-forwarder
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o bin/coraza-forwarder-darwin-amd64 ./cmd/coraza-forwarder
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o bin/coraza-forwarder-darwin-arm64 ./cmd/coraza-forwarder
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o bin/coraza-forwarder-windows-amd64.exe ./cmd/coraza-forwarder

      - name: Upload WAF binaries
        uses: actions/upload-artifact@v4
        with:
          name: waf-binaries
          path: waf/bin/
          retention-days: 7

  build-dashboard:
    name: Build Dashboard
    runs-on: ubuntu-latest
    needs: [test-dashboard]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('dashboard/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Check package-lock.json
        working-directory: ./dashboard
        run: |
          if [ ! -f "package-lock.json" ]; then
            echo "Generating package-lock.json..."
            npm install --package-lock-only --no-audit
          fi

      - name: Install dependencies
        working-directory: ./dashboard
        run: npm ci

      - name: Build dashboard
        working-directory: ./dashboard
        env:
          TZ: Europe/Zurich
          NODE_TZ: Europe/Zurich
        run: npm run build

      - name: Upload dashboard build
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-build
          path: dashboard/dist/
          retention-days: 7

  # ============================================
  # STAGE 4: PACKAGE
  # ============================================
  package:
    name: Package Release
    runs-on: ubuntu-latest
    needs: [build-api, build-waf, build-dashboard]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download API binaries
        uses: actions/download-artifact@v4
        with:
          name: api-binaries
          path: ./release/api/bin

      - name: Download WAF binaries
        uses: actions/download-artifact@v4
        with:
          name: waf-binaries
          path: ./release/waf/bin

      - name: Download Dashboard build
        uses: actions/download-artifact@v4
        with:
          name: dashboard-build
          path: ./release/dashboard

      - name: Copy configurations and scripts
        run: |
          mkdir -p ./release/waf/configs
          cp -r waf/configs/* ./release/waf/configs/
          
          mkdir -p ./release/waf/scripts
          cp -r waf/scripts/* ./release/waf/scripts/
          
          mkdir -p ./release/api/scripts
          cp -r api/scripts/* ./release/api/scripts/ 2>/dev/null || true
          
          mkdir -p ./release/docs
          cp -r docs/* ./release/docs/ 2>/dev/null || true
          cp README.md ./release/
          cp LICENSE ./release/ 2>/dev/null || true
          
          mkdir -p ./release/app
          cp -r app/* ./release/app/ 2>/dev/null || true

      - name: Create deployment README
        run: |
          cat > ./release/DEPLOYMENT.md << 'EOF'
          # WAF SIEM Advanced Detection - Deployment Package
          
          ## Package Contents
          - `api/bin/` - API server binaries
          - `waf/bin/` - WAF binaries
          - `dashboard/` - Pre-built dashboard
          - `waf/configs/` - Configuration files
          - `waf/scripts/` - Deployment scripts
          EOF

      - name: Set permissions for scripts
        run: |
          find ./release -name "*.sh" -type f -exec chmod +x {} \;

      - name: Create release archive
        run: |
          cd release
          tar -czf ../waf-siem-advanced-detection.tar.gz .
          cd ..
          zip -r waf-siem-advanced-detection.zip release/

      - name: Generate checksums
        run: |
          sha256sum waf-siem-advanced-detection.tar.gz > checksums.txt
          sha256sum waf-siem-advanced-detection.zip >> checksums.txt

      - name: Upload release package (tar.gz)
        uses: actions/upload-artifact@v4
        with:
          name: release-package-tar
          path: waf-siem-advanced-detection.tar.gz
          retention-days: 30

      - name: Upload release package (zip)
        uses: actions/upload-artifact@v4
        with:
          name: release-package-zip
          path: waf-siem-advanced-detection.zip
          retention-days: 30

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: checksums.txt
          retention-days: 30

  # ============================================
  # STAGE 5: DEPLOY (GitHub Release)
  # ============================================
  deploy:
    name: Deploy to GitHub Releases
    runs-on: ubuntu-latest
    needs: [package]
    if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download release packages
        uses: actions/download-artifact@v4
        with:
          pattern: release-package-*
          merge-multiple: true

      - name: Download checksums
        uses: actions/download-artifact@v4
        with:
          name: checksums

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            waf-siem-advanced-detection.tar.gz
            waf-siem-advanced-detection.zip
            checksums.txt
          body: |
            ## WAF SIEM Advanced Detection Release
            Download and extract the appropriate archive for your platform
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}