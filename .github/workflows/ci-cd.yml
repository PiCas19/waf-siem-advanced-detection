name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev, feature/* ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, dev ]
  release:
    types: [ created ]

env:
  GO_VERSION: '1.25'
  NODE_VERSION: '20'
  TZ: 'Europe/Zurich'  # Timezone UTC+1 (Zurich)

jobs:
  # ============================================
  # STAGE 1: INSTALL & LINT
  # ============================================
  install-and-lint:
    name: Install Dependencies & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          sudo dpkg-reconfigure --frontend noninteractive tzdata
          echo "Timezone set to: $(date)"
          echo "Current timezone: $(cat /etc/timezone)"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            api/go.sum
            waf/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Go modules (API)
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            api/.cache/go-build
          key: ${{ runner.os }}-go-api-${{ hashFiles('api/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-api-

      - name: Cache Go modules (WAF)
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            waf/.cache/go-build
          key: ${{ runner.os }}-go-waf-${{ hashFiles('waf/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-waf-

      - name: Generate go.sum if missing (API)
        working-directory: ./api
        run: |
          if [ ! -f "go.sum" ]; then
            echo "go.sum not found, generating with go mod tidy..."
            go mod tidy
            echo "go.sum generated successfully"
          else
            echo "go.sum exists, verifying..."
            go mod tidy
            go mod verify
          fi

      - name: Generate go.sum if missing (WAF)
        working-directory: ./waf
        run: |
          if [ ! -f "go.sum" ]; then
            echo "go.sum not found, generating with go mod tidy..."
            go mod tidy
            echo "go.sum generated successfully"
          else
            echo "go.sum exists, verifying..."
            go mod tidy
            go mod verify
          fi

      - name: Install Go dependencies (API)
        working-directory: ./api
        run: |
          go mod download
          go mod verify

      - name: Install Go dependencies (WAF)
        working-directory: ./waf
        run: |
          go mod download
          go mod verify

      - name: Check and create package-lock.json if missing
        working-directory: ./dashboard
        run: |
          if [ ! -f "package-lock.json" ]; then
            echo "package-lock.json not found, generating..."
            npm install --package-lock-only --no-audit
            echo "package-lock.json generated successfully"
          else
            echo "package-lock.json found, proceeding with npm ci"
          fi

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('dashboard/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install Node.js dependencies (Dashboard)
        working-directory: ./dashboard
        run: npm ci

      - name: Lint Dashboard
        working-directory: ./dashboard
        run: npm run lint

  # ============================================
  # STAGE 2: TESTS
  # ============================================
  test-api:
    name: Test API
    runs-on: ubuntu-latest
    needs: install-and-lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          echo "Current timezone: $(cat /etc/timezone)"
          echo "Current time: $(date)"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: api/go.sum

      - name: Cache Go modules for API tests
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            api/.cache/go-build
          key: ${{ runner.os }}-go-api-tests-${{ hashFiles('api/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-api-tests-

      - name: Debug directory structure (API)
        working-directory: ./api
        run: |
          echo "=== API Directory structure ==="
          find . -type f -name "*.go" | head -20
          echo "=== API Test files ==="
          find . -name "*_test.go" | head -20
          echo "=== go.mod content ==="
          cat go.mod
          echo "=== go.sum exists? ==="
          ls -la go.sum 2>/dev/null || echo "go.sum not found"

      - name: Verify go.sum exists (API)
        working-directory: ./api
        run: |
          if [ ! -f "go.sum" ]; then
            echo "ERROR: go.sum not found! Generating..."
            go mod tidy
            if [ ! -f "go.sum" ]; then
              echo "CRITICAL ERROR: Failed to generate go.sum!"
              exit 1
            fi
            echo "go.sum generated successfully"
          else
            echo "go.sum exists"
            go mod verify
          fi

      - name: Tidy Go modules
        working-directory: ./api
        run: go mod tidy

      - name: Install dependencies
        working-directory: ./api
        run: |
          go mod download
          go mod verify

      - name: Run API tests with coverage
        working-directory: ./api
        env:
          NODE_ENV: "test"
          TZ: "Europe/Zurich"
          DB_CONNECTION: "sqlite://:memory:"
          TEST_MODE: "true"
        run: |
          echo "Running API tests..."
          if [ -d "./tests" ]; then
            echo "Running tests from ./tests/ directory..."
            go test -coverprofile=coverage.out ./tests/... -coverpkg=./internal/... -v
          elif [ -d "./test" ]; then
            echo "Running tests from ./test/ directory..."
            go test -coverprofile=coverage.out ./test/... -coverpkg=./internal/... -v
          else
            echo "No specific tests directory found, running all tests..."
            go test -coverprofile=coverage.out ./... -v
          fi

      - name: Generate coverage report
        working-directory: ./api
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: api-coverage
          path: api/coverage.html
          retention-days: 7

  test-waf:
    name: Test WAF
    runs-on: ubuntu-latest
    needs: install-and-lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          echo "Current timezone: $(cat /etc/timezone)"
          echo "Current time: $(date)"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: waf/go.sum

      - name: Cache Go modules for WAF tests
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            waf/.cache/go-build
          key: ${{ runner.os }}-go-waf-tests-${{ hashFiles('waf/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-waf-tests-

      - name: Debug directory structure (WAF)
        working-directory: ./waf
        run: |
          echo "=== WAF Directory structure ==="
          find . -type f -name "*.go" | head -20
          echo "=== WAF Test files ==="
          find . -name "*_test.go" | head -20
          echo "=== go.mod content ==="
          cat go.mod
          echo "=== go.sum exists? ==="
          ls -la go.sum 2>/dev/null || echo "go.sum not found"

      - name: Verify go.sum exists (WAF)
        working-directory: ./waf
        run: |
          if [ ! -f "go.sum" ]; then
            echo "ERROR: go.sum not found! Generating..."
            go mod tidy
            if [ ! -f "go.sum" ]; then
              echo "CRITICAL ERROR: Failed to generate go.sum!"
              exit 1
            fi
            echo "go.sum generated successfully"
          else
            echo "go.sum exists"
            go mod verify
          fi

      - name: Tidy Go modules
        working-directory: ./waf
        run: go mod tidy

      - name: Install dependencies
        working-directory: ./waf
        run: |
          go mod download
          go mod verify

      - name: Run WAF tests with coverage
        working-directory: ./waf
        env:
          NODE_ENV: "test"
          TZ: "Europe/Zurich"
          TEST_MODE: "true"
        run: |
          echo "Running WAF tests..."
          if [ -d "./tests" ]; then
            echo "Running tests from ./tests/ directory..."
            go test -coverprofile=coverage.out ./tests/... -coverpkg=./internal/... -v
          elif [ -d "./test" ]; then
            echo "Running tests from ./test/ directory..."
            go test -coverprofile=coverage.out ./test/... -coverpkg=./internal/... -v
          else
            echo "No specific tests directory found, running all tests..."
            go test -coverprofile=coverage.out ./... -v
          fi

      - name: Generate coverage report
        working-directory: ./waf
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: waf-coverage
          path: waf/coverage.html
          retention-days: 7

  test-dashboard:
    name: Test Dashboard
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: install-and-lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          echo "Current timezone: $(cat /etc/timezone)"
          echo "Current time: $(date)"

      - name: Setup Node.js (SENZA CACHE)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # NIENTE CACHE - rimuoviamo il problema

      - name: Install dependencies
        working-directory: ./dashboard
        run: |
          # Pulisci cache manualmente
          npm cache clean --force 2>/dev/null || true
          
          # Installa normalmente
          npm ci

      - name: Increase test timeout globally
        working-directory: ./dashboard
        run: |
          # Aggiungi timeout globale nel package.json o crea file di configurazione
          if [ -f "vitest.config.ts" ] || [ -f "vitest.config.js" ]; then
            echo "Vitest config found, modifying..."
            # Crea backup e modifica
            cp vitest.config.ts vitest.config.ts.backup 2>/dev/null || cp vitest.config.js vitest.config.js.backup 2>/dev/null || true
            
            # Crea config temporaneo
            cat > vitest.config.ci.ts << 'EOF'
            import { defineConfig } from 'vitest/config';
            import react from '@vitejs/plugin-react';

            export default defineConfig({
              plugins: [react()],
              test: {
                environment: 'jsdom',
                globals: true,
                testTimeout: 30000,
                hookTimeout: 30000,
                setupFiles: ['./src/test/setup.ts'],
              },
            });
            EOF
            
            # Usa config CI
            cp vitest.config.ci.ts vitest.config.ts 2>/dev/null || cp vitest.config.ci.ts vitest.config.js 2>/dev/null || true
          else
            echo "Creating vitest config for CI..."
            cat > vitest.config.ts << 'EOF'
            import { defineConfig } from 'vitest/config';
            import react from '@vitejs/plugin-react';

            export default defineConfig({
              plugins: [react()],
              test: {
                environment: 'jsdom',
                globals: true,
                testTimeout: 30000,
                hookTimeout: 30000,
                setupFiles: ['./src/test/setup.ts'],
              },
            });
            EOF
          fi

      - name: Run tests with increased timeout
        working-directory: ./dashboard
        env:
          TZ: Europe/Zurich
          NODE_TZ: Europe/Zurich
          NODE_ENV: test
          CI: true
        run: |
          # Aumenta memoria Node.js
          export NODE_OPTIONS="--max-old-space-size=4096"
          
          echo "=== Running tests with 30s timeout ==="
          
          # Controlla quale comando esiste
          if grep -q '"test"' package.json; then
            echo "Running: npm test"
            npm test -- --testTimeout=30000 --hookTimeout=30000 --no-watch --reporter=verbose 2>&1
          elif grep -q '"test:run"' package.json; then
            echo "Running: npm run test:run"
            npm run test:run -- --testTimeout=30000 --hookTimeout=30000 --no-watch --reporter=verbose 2>&1
          else
            echo "Running: npx vitest run"
            npx vitest run --testTimeout=30000 --hookTimeout=30000 --no-watch --reporter=verbose 2>&1
          fi

      - name: Generate coverage
        if: success()
        working-directory: ./dashboard
        env:
          TZ: Europe/Zurich
          NODE_TZ: Europe/Zurich
          NODE_ENV: test
          CI: true
        run: |
          export NODE_OPTIONS="--max-old-space-size=4096"
          
          if grep -q '"test:coverage"' package.json; then
            npm run test:coverage 2>&1
          else
            npx vitest run --coverage 2>&1
          fi

      - name: Upload coverage
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-coverage
          path: dashboard/coverage/
          retention-days: 7

  # ============================================
  # STAGE 3: BUILD
  # ============================================
  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: [test-api]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          echo "Current timezone: $(cat /etc/timezone)"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: api/go.sum

      - name: Cache Go modules for API build
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            api/.cache/go-build
          key: ${{ runner.os }}-go-api-build-${{ hashFiles('api/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-api-build-

      - name: Verify go.sum exists (API Build)
        working-directory: ./api
        run: |
          if [ ! -f "go.sum" ]; then
            echo "ERROR: go.sum not found! Generating..."
            go mod tidy
            if [ ! -f "go.sum" ]; then
              echo "CRITICAL ERROR: Failed to generate go.sum!"
              exit 1
            fi
            echo "go.sum generated successfully"
          fi

      - name: Tidy Go modules
        working-directory: ./api
        run: go mod tidy

      - name: Install dependencies
        working-directory: ./api
        run: |
          go mod download
          go mod verify

      - name: Build API server
        working-directory: ./api
        run: |
          mkdir -p bin
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o bin/api-server-linux-amd64 ./cmd/api-server
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o bin/api-server-darwin-amd64 ./cmd/api-server
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o bin/api-server-darwin-arm64 ./cmd/api-server
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o bin/api-server-windows-amd64.exe ./cmd/api-server

      - name: Upload API binaries
        uses: actions/upload-artifact@v4
        with:
          name: api-binaries
          path: api/bin/
          retention-days: 7

  build-waf:
    name: Build WAF
    runs-on: ubuntu-latest
    needs: [test-waf]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          echo "Current timezone: $(cat /etc.timezone)"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: waf/go.sum

      - name: Cache Go modules for WAF build
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            waf/.cache/go-build
          key: ${{ runner.os }}-go-waf-build-${{ hashFiles('waf/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-waf-build-

      - name: Verify go.sum exists (WAF Build)
        working-directory: ./waf
        run: |
          if [ ! -f "go.sum" ]; then
            echo "ERROR: go.sum not found! Generating..."
            go mod tidy
            if [ ! -f "go.sum" ]; then
              echo "CRITICAL ERROR: Failed to generate go.sum!"
              exit 1
            fi
            echo "go.sum generated successfully"
          fi

      - name: Tidy Go modules
        working-directory: ./waf
        run: go mod tidy

      - name: Install dependencies
        working-directory: ./waf
        run: |
          go mod download
          go mod verify

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      - name: Build Caddy with WAF plugin
        working-directory: ./waf
        run: |
          mkdir -p bin
          xcaddy build --output bin/caddy-waf-linux-amd64
          GOOS=darwin GOARCH=amd64 xcaddy build --output bin/caddy-waf-darwin-amd64
          GOOS=darwin GOARCH=arm64 xcaddy build --output bin/caddy-waf-darwin-arm64
          GOOS=windows GOARCH=amd64 xcaddy build --output bin/caddy-waf-windows-amd64.exe

      - name: Build Coraza Forwarder
        working-directory: ./waf
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o bin/coraza-forwarder-linux-amd64 ./cmd/coraza-forwarder
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o bin/coraza-forwarder-darwin-amd64 ./cmd/coraza-forwarder
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o bin/coraza-forwarder-darwin-arm64 ./cmd/coraza-forwarder
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o bin/coraza-forwarder-windows-amd64.exe ./cmd/coraza-forwarder

      - name: Upload WAF binaries
        uses: actions/upload-artifact@v4
        with:
          name: waf-binaries
          path: waf/bin/
          retention-days: 7

  build-dashboard:
    name: Build Dashboard
    runs-on: ubuntu-latest
    needs: [test-dashboard]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          echo "Current timezone: $(cat /etc/timezone)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('dashboard/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Check package-lock.json
        working-directory: ./dashboard
        run: |
          if [ ! -f "package-lock.json" ]; then
            echo "Error: package-lock.json not found in build-dashboard"
            echo "Generating package-lock.json..."
            npm install --package-lock-only --no-audit
          fi

      - name: Install dependencies
        working-directory: ./dashboard
        run: npm ci

      - name: Build dashboard
        working-directory: ./dashboard
        env:
          TZ: Europe/Zurich
          NODE_TZ: Europe/Zurich
          NODE_ENV: production
        run: npm run build

      - name: Upload dashboard build
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-build
          path: dashboard/dist/
          retention-days: 7

  # ============================================
  # STAGE 4: PACKAGE
  # ============================================
  package:
    name: Package Release
    runs-on: ubuntu-latest
    needs: [build-api, build-waf, build-dashboard]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          echo "Current timezone: $(cat /etc/timezone)"

      - name: Download API binaries
        uses: actions/download-artifact@v4
        with:
          name: api-binaries
          path: ./release/api/bin

      - name: Download WAF binaries
        uses: actions/download-artifact@v4
        with:
          name: waf-binaries
          path: ./release/waf/bin

      - name: Download Dashboard build
        uses: actions/download-artifact@v4
        with:
          name: dashboard-build
          path: ./release/dashboard

      - name: Copy configurations and scripts
        run: |
          mkdir -p ./release/waf/configs
          cp -r waf/configs/* ./release/waf/configs/ 2>/dev/null || true

          mkdir -p ./release/waf/scripts
          cp -r waf/scripts/* ./release/waf/scripts/ 2>/dev/null || true

          mkdir -p ./release/api/scripts
          cp -r api/scripts/* ./release/api/scripts/ 2>/dev/null || true

          mkdir -p ./release/docs
          cp -r docs/* ./release/docs/ 2>/dev/null || true
          cp README.md ./release/ 2>/dev/null || true
          cp LICENSE ./release/ 2>/dev/null || true

          mkdir -p ./release/app
          cp -r app/* ./release/app/ 2>/dev/null || true

      - name: Create deployment README
        run: |
          cat > ./release/DEPLOYMENT.md << 'EOF'
          # WAF SIEM Advanced Detection - Deployment Package

          ## Package Contents

          - `api/bin/` - API server binaries for multiple platforms
          - `waf/bin/` - WAF binaries (Caddy + Coraza Forwarder) for multiple platforms
          - `dashboard/` - Pre-built dashboard (static files)
          - `waf/configs/` - WAF configuration files
          - `waf/scripts/` - Deployment and management scripts
          - `docs/` - Documentation
          - `app/` - Sample applications

          ## Quick Start

          ### 1. API Server
          ```bash
          # Linux
          cd api/bin
          chmod +x api-server-linux-amd64
          ./api-server-linux-amd64

          # macOS (Intel)
          chmod +x api-server-darwin-amd64
          ./api-server-darwin-amd64

          # macOS (Apple Silicon)
          chmod +x api-server-darwin-arm64
          ./api-server-darwin-arm64
          ```

          ### 2. WAF
          ```bash
          # Linux
          cd waf/bin
          chmod +x caddy-waf-linux-amd64
          chmod +x coraza-forwarder-linux-amd64

          # Start Caddy WAF
          ./caddy-waf-linux-amd64 run --config ../configs/Caddyfile

          # Start Coraza Forwarder
          ./coraza-forwarder-linux-amd64
          ```

          ### 3. Dashboard
          Serve the `dashboard/` directory with any web server:
          ```bash
          # Using Python
          cd dashboard
          python3 -m http.server 3000

          # Using Node.js
          npx serve -s . -p 3000

          # Using Nginx (copy to /var/www/html)
          ```

          ## Configuration

          1. Configure API connection in dashboard
          2. Update WAF configs in `waf/configs/`
          3. Run firewall setup scripts if needed (see `waf/scripts/`)

          ## Platform Selection

          - Linux: `*-linux-amd64`
          - macOS Intel: `*-darwin-amd64`
          - macOS Apple Silicon: `*-darwin-arm64`
          - Windows: `*-windows-amd64.exe`

          For detailed instructions, see `docs/installation.md`
          EOF

      - name: Set permissions for scripts
        run: |
          find ./release -name "*.sh" -type f -exec chmod +x {} \; 2>/dev/null || true
          find ./release -type f -name "*-linux-*" -exec chmod +x {} \; 2>/dev/null || true
          find ./release -type f -name "*-darwin-*" -exec chmod +x {} \; 2>/dev/null || true

      - name: Create release archive
        run: |
          mkdir -p release
          cd release
          tar -czf ../waf-siem-advanced-detection.tar.gz .
          cd ..
          zip -r waf-siem-advanced-detection.zip release/

      - name: Generate checksums
        run: |
          sha256sum waf-siem-advanced-detection.tar.gz > checksums.txt
          sha256sum waf-siem-advanced-detection.zip >> checksums.txt

      - name: Upload release package (tar.gz)
        uses: actions/upload-artifact@v4
        with:
          name: release-package-tar
          path: waf-siem-advanced-detection.tar.gz
          retention-days: 30

      - name: Upload release package (zip)
        uses: actions/upload-artifact@v4
        with:
          name: release-package-zip
          path: waf-siem-advanced-detection.zip
          retention-days: 30

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: checksums.txt
          retention-days: 30

  # ============================================
  # STAGE 5: DEPLOY (GitHub Release)
  # ============================================
  deploy:
    name: Deploy to GitHub Releases
    runs-on: ubuntu-latest
    needs: [package]
    if: github.event_name == 'release' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set timezone to Europe/Zurich
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime
          echo "Europe/Zurich" | sudo tee /etc/timezone
          echo "Current timezone: $(cat /etc/timezone)"

      - name: Download release packages
        uses: actions/download-artifact@v4
        with:
          pattern: release-package-*
          merge-multiple: true

      - name: Download checksums
        uses: actions/download-artifact@v4
        with:
          name: checksums

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            waf-siem-advanced-detection.tar.gz
            waf-siem-advanced-detection.zip
            checksums.txt
          body: |
            ## WAF SIEM Advanced Detection Release

            ### Installation

            Download the appropriate archive for your platform:
            - `waf-siem-advanced-detection.tar.gz` (recommended for Linux/macOS)
            - `waf-siem-advanced-detection.zip` (recommended for Windows)

            Extract and follow instructions in `DEPLOYMENT.md`

            ### Checksums
            See `checksums.txt` for SHA256 verification

            ### What's Included
            - API Server (multi-platform binaries)
            - WAF with Caddy + Coraza (multi-platform binaries)
            - Pre-built Dashboard
            - Configuration files
            - Deployment scripts
            - Documentation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}