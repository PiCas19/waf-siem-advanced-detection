# ==============================================================================
# Coraza WAF Configuration
# OWASP ModSecurity Core Rule Set v4.0
# ==============================================================================

# ==============================================================================
# Engine Configuration
# ==============================================================================

SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off

# Request Body Limits (10MB max)
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# File Upload
SecTmpDir /tmp
SecUploadDir /tmp
SecUploadKeepFiles Off

# ==============================================================================
# Logging Configuration
# ==============================================================================

# Audit disabled - Custom WAF logs everything
SecAuditEngine Off

# Debug disabled - not needed
# SecDebugLog /var/log/caddy/coraza_debug.log
# SecDebugLogLevel 0

# ==============================================================================
# OWASP Core Rule Set v4.0
# ==============================================================================

# Unicode Mapping (not supported in Coraza)
# SecUnicodeMapFile /etc/caddy/waf/coreruleset/unicode.mapping

# CRS Setup Configuration
Include /etc/caddy/waf/coreruleset/crs-setup.conf.example

# Initialization and Exceptions
Include /etc/caddy/waf/coreruleset/rules/REQUEST-901-INITIALIZATION.conf
# Include /etc/caddy/waf/coreruleset/rules/REQUEST-903.9001-DRUPAL-EXCLUSION-RULES.conf  # Not in v4.7.0
# Include /etc/caddy/waf/coreruleset/rules/REQUEST-903.9002-WORDPRESS-EXCLUSION-RULES.conf  # Not in v4.7.0
Include /etc/caddy/waf/coreruleset/rules/REQUEST-905-COMMON-EXCEPTIONS.conf

# Attack Detection Rules
# Include /etc/caddy/waf/coreruleset/rules/REQUEST-910-IP-REPUTATION.conf  # Not in v4.7.0
Include /etc/caddy/waf/coreruleset/rules/REQUEST-911-METHOD-ENFORCEMENT.conf
# Include /etc/caddy/waf/coreruleset/rules/REQUEST-912-DOS-PROTECTION.conf  # Not in v4.7.0
Include /etc/caddy/waf/coreruleset/rules/REQUEST-913-SCANNER-DETECTION.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-921-PROTOCOL-ATTACK.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-922-MULTIPART-ATTACK.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-931-APPLICATION-ATTACK-RFI.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-933-APPLICATION-ATTACK-PHP.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-934-APPLICATION-ATTACK-GENERIC.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-943-APPLICATION-ATTACK-SESSION-FIXATION.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-944-APPLICATION-ATTACK-JAVA.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-949-BLOCKING-EVALUATION.conf

# Response Rules
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-950-DATA-LEAKAGES.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-951-DATA-LEAKAGES-SQL.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-952-DATA-LEAKAGES-JAVA.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-953-DATA-LEAKAGES-PHP.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-954-DATA-LEAKAGES-IIS.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-955-WEB-SHELLS.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-959-BLOCKING-EVALUATION.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-980-CORRELATION.conf

# ==============================================================================
# Custom Application Rules (ID Range: 9000-9999)
# ==============================================================================

# ------------------------------------------------------------------------------
# Web Attack Protection (9000-9099)
# ------------------------------------------------------------------------------

# XSS Protection
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS|REQUEST_BODY "@rx (?i)(<script|javascript:|onerror=|onload=|eval\(|alert\(|<iframe|<object|<embed)" \
    "id:9001,phase:2,deny,status:403,log,msg:'XSS Attack Detected',severity:2,tag:'attack-xss'"

SecRule REQUEST_URI|ARGS "@rx (?i)(data:text/html)" \
    "id:9002,phase:2,deny,status:403,log,msg:'XSS via Data URI',severity:2,tag:'attack-xss'"

SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(on(load|error|click|mouse|focus|blur|change|submit)=)" \
    "id:9003,phase:2,deny,status:403,log,msg:'XSS Event Handler',severity:2,tag:'attack-xss'"

# SQL Injection Protection
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(union.*select|insert.*into|delete.*from|drop.*table|drop.*database|exec.*\(|execute.*\()" \
    "id:9010,phase:2,deny,status:403,log,msg:'SQL Injection',severity:2,tag:'attack-sqli'"

SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(--|;|/\*|\*/|'.*or.*'.*=.*'|'.*or.*1.*=.*1)" \
    "id:9011,phase:2,deny,status:403,log,msg:'SQL Injection Comment/Trick',severity:2,tag:'attack-sqli'"

SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)('.*or.*'|admin'.*--|'.*=.*')" \
    "id:9012,phase:2,deny,status:403,log,msg:'SQL Auth Bypass',severity:2,tag:'attack-sqli'"

# Path Traversal Protection
SecRule REQUEST_URI|ARGS "@rx (?i)(\.\./|\.\.\\|/etc/passwd|/etc/shadow|/etc/hosts|\\windows\\|c:\\)" \
    "id:9020,phase:2,deny,status:403,log,msg:'Path Traversal',severity:2,tag:'attack-lfi'"

SecRule REQUEST_URI|ARGS "@rx (?i)(%2e%2e/|%2e%2e%5c|%252e%252e)" \
    "id:9021,phase:2,deny,status:403,log,msg:'Encoded Path Traversal',severity:2,tag:'attack-lfi'"

# Command Injection Protection
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(;.*whoami|;.*cat|;.*ls|;.*id|;.*pwd|\$\(|\`|&&|\|\|)" \
    "id:9030,phase:2,deny,status:403,log,msg:'Command Injection',severity:2,tag:'attack-rce'"

SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(exec\(|system\(|passthru\(|shell_exec\(|popen\()" \
    "id:9031,phase:2,deny,status:403,log,msg:'Command Execution Function',severity:2,tag:'attack-rce'"

# Remote File Inclusion
SecRule ARGS "@rx (?i)(https?://|ftp://|file://)" \
    "id:9040,phase:2,deny,status:403,log,msg:'Remote File Inclusion',severity:3,tag:'attack-rfi'"

# Server-Side Template Injection
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(\{\{.*\}\}|\{%.*%\}|<%.*%>)" \
    "id:9050,phase:2,deny,status:403,log,msg:'Template Injection',severity:3,tag:'attack-ssti'"

# LDAP Injection
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(\(\||\*\)|\)\()" \
    "id:9060,phase:2,deny,status:403,log,msg:'LDAP Injection',severity:3,tag:'attack-ldap'"

# XXE Attack
SecRule REQUEST_BODY "@rx (?i)(<!ENTITY|<!DOCTYPE.*\[)" \
    "id:9070,phase:2,deny,status:403,log,msg:'XXE Attack',severity:3,tag:'attack-xxe'"

# NoSQL Injection
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(\$ne|\$gt|\$lt|\$where|\$regex)" \
    "id:9080,phase:2,deny,status:403,log,msg:'NoSQL Injection',severity:3,tag:'attack-nosql'"

# ------------------------------------------------------------------------------
# Application-Specific Protection (9100-9399)
# ------------------------------------------------------------------------------

# Dashboard Protection - Restrict Admin Endpoints
SecRule REQUEST_URI "@rx (?i)/api/(users|admin|config|secrets)" \
    "id:9100,phase:1,deny,status:403,log,msg:'Unauthorized API Access',severity:3,tag:'dashboard-protection',chain"
    SecRule REMOTE_ADDR "!@ipMatch 127.0.0.1,::1,100.64.0.0/10,192.168.216.0/24,172.16.216.0/24"

# Dashboard Protection - Monitor Login Attempts
SecRule REQUEST_URI "@rx (?i)/api/auth/login" \
    "id:9101,phase:2,log,msg:'Login Attempt',severity:5,tag:'dashboard-monitoring'"

# Scanner Detection - Block Security Scanners
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(nikto|sqlmap|nmap|masscan|dirbuster|gobuster|wpscan|acunetix)" \
    "id:9110,phase:1,deny,status:403,log,msg:'Security Scanner',severity:3,tag:'attack-scanner'"

# Finance Application - Protect Sensitive Endpoints
SecRule REQUEST_URI "@rx (?i)/finance/(admin|config|internal)" \
    "id:9200,phase:1,deny,status:403,log,msg:'Unauthorized Finance Endpoint',severity:3,tag:'finance-protection'"

# Finance Application - Validate Transaction Amounts
SecRule ARGS:amount "@rx ^-|^[0-9]{10,}$" \
    "id:9201,phase:2,deny,status:400,log,msg:'Invalid Transaction Amount',severity:4,tag:'finance-validation'"

# Industrial Application - Protect Control Endpoints
SecRule REQUEST_URI "@rx (?i)/industrial/(control|scada|plc|settings)" \
    "id:9300,phase:1,deny,status:403,log,msg:'Unauthorized Industrial Access',severity:2,tag:'industrial-protection'"

# Industrial Application - Block Dangerous Commands
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(shutdown|restart|emergency_stop|override)" \
    "id:9301,phase:2,deny,status:403,log,msg:'Dangerous Industrial Command',severity:2,tag:'industrial-protection'"

# ------------------------------------------------------------------------------
# Common Attack Patterns (9500-9599)
# ------------------------------------------------------------------------------

# Null Byte Injection
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx \x00" \
    "id:9500,phase:2,deny,status:403,log,msg:'Null Byte Injection',severity:3,tag:'attack-evasion'"

# HTTP Response Splitting
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS "@rx (?i)(%0d%0a|\r\n)" \
    "id:9501,phase:2,deny,status:403,log,msg:'HTTP Response Splitting',severity:3,tag:'attack-splitting'"

# CRLF Injection
SecRule REQUEST_URI|ARGS "@rx (?:%0[ad]|\\r|\\n)" \
    "id:9502,phase:2,deny,status:403,log,msg:'CRLF Injection',severity:3,tag:'attack-injection'"

# ------------------------------------------------------------------------------
# Information Disclosure Prevention (9600-9699)
# ------------------------------------------------------------------------------

# Block Sensitive File Access
SecRule REQUEST_URI "@rx (?i)\.(env|git|svn|htaccess|htpasswd|sql|bak|backup|log|conf|config|ini)$" \
    "id:9600,phase:1,deny,status:403,log,msg:'Sensitive File Access',severity:3,tag:'info-disclosure'"

# Block Directory Listing Attempts
SecRule REQUEST_URI "@rx (?i)/(\.\.;|\.\.%00)" \
    "id:9601,phase:1,deny,status:403,log,msg:'Directory Listing Attempt',severity:4,tag:'info-disclosure'"
