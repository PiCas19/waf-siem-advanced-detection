# =========================================
# WAF Rules Configuration - OWASP CRS Based
# =========================================

version: "1.0"
owasp_crs_version: "4.0"
paranoia_level: 1  # 1-4, higher = more strict

# =========================================
# Core Detection Rules
# =========================================
rules:
  # Cross-Site Scripting (XSS)
  xss:
    enabled: true
    block_mode: true
    severity: high
    description: "Cross-Site Scripting detection - OWASP CRS Rules 941xxx"
    rule_ids:
      - 941100  # libinjection XSS
      - 941110  # Script tag vectors
      - 941120  # Event handler vectors
      - 941130  # Attribute/style vectors
      - 941140  # JavaScript URI vectors
      - 941150  # Disallowed HTML attributes
      - 941160  # UTF encoding
      - 941170  # JavaScript methods
      - 941180  # SVG/XML vectors
      - 941190  # Template injection
    anomaly_score: 5

  # SQL Injection (SQLi)
  sqli:
    enabled: true
    block_mode: true
    severity: critical
    description: "SQL Injection detection - OWASP CRS Rules 942xxx"
    rule_ids:
      - 942100  # libinjection SQLi
      - 942110  # Common injection testing
      - 942120  # SQL operators
      - 942130  # SQL tautology
      - 942140  # DB schema enumeration
      - 942150  # Blind SQLi
      - 942160  # SQL functions
      - 942170  # Stored procedures
      - 942180  # SQL comments
      - 942190  # Stacked queries
      - 942200  # Error-based SQLi
    anomaly_score: 5

  # Local File Inclusion (LFI)
  lfi:
    enabled: true
    block_mode: true
    severity: high
    description: "Local File Inclusion detection - OWASP CRS Rules 930xxx"
    rule_ids:
      - 930100  # Path traversal
      - 930110  # Encoded traversal
      - 930120  # OS file access
      - 930130  # Restricted file access
      - 930140  # PHP wrappers
    anomaly_score: 5

  # Remote File Inclusion (RFI)
  rfi:
    enabled: true
    block_mode: true
    severity: critical
    description: "Remote File Inclusion detection - OWASP CRS Rules 931xxx"
    rule_ids:
      - 931100  # URL parameter RFI
      - 931110  # Common RFI parameters
      - 931120  # SSRF attempts
      - 931130  # Cloud metadata access
    anomaly_score: 5

  # Command Injection / Remote Code Execution (RCE)
  command_injection:
    enabled: true
    block_mode: true
    severity: critical
    description: "Command Injection detection - OWASP CRS Rules 932xxx"
    rule_ids:
      - 932100  # Unix command injection
      - 932110  # Windows command injection
      - 932120  # Shell invocation
      - 932130  # Command substitution
      - 932140  # Network commands
      - 932150  # File operations
      - 932160  # Reverse shells
    anomaly_score: 5

  # Protocol Attacks
  protocol_attack:
    enabled: true
    block_mode: true
    severity: high
    description: "Protocol violation detection - OWASP CRS Rules 920xxx"
    rule_ids:
      - 920100  # Invalid HTTP request
      - 920110  # Invalid HTTP method
      - 920120  # Missing Content-Type
      - 920130  # Failed body parse
      - 920140  # Multipart validation
      - 920150  # HTTP header injection
    anomaly_score: 3

  # Session Fixation
  session_fixation:
    enabled: true
    block_mode: false  # Warning mode
    severity: medium
    description: "Session fixation detection - OWASP CRS Rules 943xxx"
    rule_ids:
      - 943100  # Session ID in parameter
      - 943110  # Session ID in URL
    anomaly_score: 3

  # Scanner/Bot Detection
  scanner_detection:
    enabled: true
    block_mode: true
    severity: low
    description: "Security scanner detection - OWASP CRS Rules 913xxx"
    rule_ids:
      - 913100  # Security scanners
      - 913110  # Web crawlers
      - 913120  # Anomaly score exceeded
    anomaly_score: 2

  # DoS/Rate Limiting
  rate_limiting:
    enabled: true
    block_mode: true
    severity: high
    description: "DoS protection - OWASP CRS Rules 912xxx"
    rule_ids:
      - 912100  # DoS attack
      - 912110  # Rate limit exceeded
    anomaly_score: 4

  # XXE (XML External Entity)
  xxe:
    enabled: true
    block_mode: true
    severity: critical
    description: "XML External Entity attack detection - OWASP CRS Rules 950xxx"
    rule_ids:
      - 950100  # External entity declaration
      - 950110  # Entity expansion (billion laughs)
      - 950120  # XInclude
    anomaly_score: 5

  # SSRF (Server-Side Request Forgery)
  ssrf:
    enabled: true
    block_mode: true
    severity: critical
    description: "Server-Side Request Forgery detection - OWASP CRS Rules 951xxx"
    rule_ids:
      - 951100  # Localhost access
      - 951110  # Private IP ranges
      - 951120  # Cloud metadata
    anomaly_score: 5

  # NoSQL Injection
  nosql_injection:
    enabled: true
    block_mode: true
    severity: critical
    description: "NoSQL Injection detection - OWASP CRS Rules 952xxx"
    rule_ids:
      - 952100  # MongoDB operators
      - 952110  # Authentication bypass
    anomaly_score: 5

  # LDAP Injection
  ldap_injection:
    enabled: true
    block_mode: true
    severity: high
    description: "LDAP Injection detection - OWASP CRS Rules 953xxx"
    rule_ids:
      - 953100  # Filter injection
      - 953110  # Authentication bypass
    anomaly_score: 4

  # SSTI (Server-Side Template Injection)
  ssti:
    enabled: true
    block_mode: true
    severity: critical
    description: "Server-Side Template Injection detection - OWASP CRS Rules 954xxx"
    rule_ids:
      - 954100  # Template expression
      - 954110  # Python template injection
      - 954120  # Ruby ERB injection
    anomaly_score: 5

  # HTTP Response Splitting
  response_splitting:
    enabled: true
    block_mode: true
    severity: high
    description: "HTTP Response Splitting/CRLF Injection detection - OWASP CRS Rules 955xxx"
    rule_ids:
      - 955100  # CRLF injection
      - 955110  # Header injection
    anomaly_score: 4

  # Prototype Pollution
  prototype_pollution:
    enabled: true
    block_mode: true
    severity: high
    description: "Prototype Pollution detection - OWASP CRS Rules 956xxx"
    rule_ids:
      - 956100  # __proto__ access
      - 956110  # constructor.prototype
    anomaly_score: 4

  # Path Traversal (Advanced)
  path_traversal:
    enabled: true
    block_mode: true
    severity: high
    description: "Advanced Path Traversal detection - OWASP CRS Rules 957xxx"
    rule_ids:
      - 957100  # Directory traversal
      - 957110  # Encoded traversal
      - 957120  # Null byte injection
    anomaly_score: 5

# =========================================
# Anomaly Scoring Configuration
# =========================================
anomaly_scoring:
  enabled: true
  threshold:
    inbound: 5    # Block if score >= 5
    outbound: 4   # Block if response score >= 4

  # Score increments by severity
  score_increments:
    critical: 5
    high: 4
    medium: 3
    low: 2
    notice: 1

# =========================================
# Request/Response Inspection
# =========================================
inspection:
  # Request inspection
  request:
    headers: true
    cookies: true
    query_params: true
    post_params: true
    json_body: true
    xml_body: true
    multipart: true
    url_path: true
    user_agent: true
    referer: true

  # Response inspection
  response:
    headers: true
    body: false  # Can be performance intensive
    status_codes: true

# =========================================
# Vectors to Inspect (All Attack Surfaces)
# =========================================
attack_vectors:
  enabled_vectors:
    - headers           # All HTTP headers
    - cookies           # Individual cookies
    - query_params      # URL query parameters
    - post_params       # POST form data
    - json_body         # JSON payloads
    - xml_body          # XML payloads
    - url_path          # URL path
    - url_fragment      # URL fragment
    - user_agent        # User-Agent header
    - referer           # Referer header
    - origin            # Origin header
    - x_forwarded_for   # X-Forwarded-For
    - x_real_ip         # X-Real-IP
    - authorization     # Authorization header
    - content_type      # Content-Type header
    - host              # Host header

# =========================================
# Logging Configuration
# =========================================
logging:
  format: json
  file: /var/log/caddy/waf.log
  level: info

  # Log fields
  include_fields:
    - timestamp
    - client_ip
    - request_id
    - method
    - uri
    - user_agent
    - threat_type
    - threat_severity
    - rule_id
    - attack_vector
    - parameter_name
    - payload
    - action_taken
    - anomaly_score
    - matched_pattern

  # SIEM integration
  siem:
    enabled: true
    format: cef  # Common Event Format
    syslog_server: "localhost:514"
    facility: local0

# =========================================
# Blocklist Configuration
# =========================================
blocklist:
  enabled: true
  auto_block_threshold: 5    # Block after 5 violations
  block_duration_seconds: 3600  # 1 hour

  # Persistent blocklist
  persistent: true
  storage_path: /var/lib/caddy/waf_blocklist.db

  # Whitelist (IPs that should never be blocked)
  whitelist:
    - 127.0.0.1
    - ::1
    # Add trusted IPs here

# =========================================
# Performance Settings
# =========================================
performance:
  max_body_size: 10485760      # 10MB
  timeout_seconds: 30
  max_regex_execution_time: 100 # milliseconds

  # Caching
  pattern_cache: true
  cache_size: 1000
  cache_ttl_seconds: 3600

# =========================================
# Response Actions
# =========================================
actions:
  # Action when threat detected
  on_threat_detected:
    - block          # Block the request
    - log            # Log to file
    - alert          # Send alert (if configured)
    - increment_score # Increase anomaly score

  # Custom error pages
  error_pages:
    403: /etc/caddy/error_pages/403.html
    429: /etc/caddy/error_pages/429.html

# =========================================
# Monitoring & Metrics
# =========================================
metrics:
  enabled: true
  endpoint: /metrics
  prometheus_format: true

  # Metrics to expose
  expose:
    - total_requests
    - blocked_requests
    - threats_detected_by_type
    - threats_detected_by_severity
    - response_time
    - false_positives
    - blocked_ips_count

# =========================================
# Advanced Features
# =========================================
advanced:
  # GeoIP blocking
  geoip:
    enabled: false
    database_path: /var/lib/geoip/GeoLite2-Country.mmdb
    blocked_countries: []

  # Machine Learning based detection
  ml_detection:
    enabled: false
    model_path: /var/lib/caddy/ml_model.pb

  # Honeypot integration
  honeypot:
    enabled: false
    hidden_fields: []