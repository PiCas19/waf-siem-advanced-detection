# ==============================================================================
# Coraza WAF Configuration
# OWASP ModSecurity Core Rule Set v4.0
# ==============================================================================

# Basic Configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off

# Request Body Limits
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Debug Logging (set to 3 for production, 9 for debugging)
SecDebugLog /var/log/caddy/coraza_debug.log
SecDebugLogLevel 3

# Audit Logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABCFHZ
SecAuditLogType Serial
SecAuditLog /var/log/caddy/coraza_audit.log

# File Upload Settings
SecTmpDir /tmp
SecUploadDir /tmp
SecUploadKeepFiles Off

# Unicode Support
SecUnicodeMapFile /etc/caddy/waf/coreruleset/unicode.mapping

# ==============================================================================
# OWASP Core Rule Set v4.0 - Include Rules
# ==============================================================================

# CRS Configuration
Include /etc/caddy/waf/coreruleset/crs-setup.conf.example

# Protocol Attacks
Include /etc/caddy/waf/coreruleset/rules/REQUEST-901-INITIALIZATION.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-903.9001-DRUPAL-EXCLUSION-RULES.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-903.9002-WORDPRESS-EXCLUSION-RULES.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-905-COMMON-EXCEPTIONS.conf

# Attack Detection Rules
Include /etc/caddy/waf/coreruleset/rules/REQUEST-910-IP-REPUTATION.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-911-METHOD-ENFORCEMENT.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-912-DOS-PROTECTION.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-913-SCANNER-DETECTION.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-921-PROTOCOL-ATTACK.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-922-MULTIPART-ATTACK.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-931-APPLICATION-ATTACK-RFI.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-933-APPLICATION-ATTACK-PHP.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-934-APPLICATION-ATTACK-NODEJS.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-943-APPLICATION-ATTACK-SESSION-FIXATION.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-944-APPLICATION-ATTACK-JAVA.conf
Include /etc/caddy/waf/coreruleset/rules/REQUEST-949-BLOCKING-EVALUATION.conf

# Response Rules
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-950-DATA-LEAKAGES.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-951-DATA-LEAKAGES-SQL.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-952-DATA-LEAKAGES-JAVA.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-953-DATA-LEAKAGES-PHP.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-954-DATA-LEAKAGES-IIS.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-959-BLOCKING-EVALUATION.conf
Include /etc/caddy/waf/coreruleset/rules/RESPONSE-980-CORRELATION.conf

# ==============================================================================
# Custom Rules (Finance, Industrial & Dashboard Protection)
# ==============================================================================

# ===== XSS Protection =====
# Block common XSS patterns in URI, arguments, headers, and request body
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS|REQUEST_BODY "@rx (?i)(<script|javascript:|onerror=|onload=|eval\(|alert\(|<iframe|<object|<embed)" \
    "id:9001,phase:2,deny,status:403,log,msg:'XSS Attack Detected',severity:CRITICAL,tag:'attack-xss'"

# Block XSS via data URIs
SecRule REQUEST_URI|ARGS "@rx (?i)(data:text/html)" \
    "id:9002,phase:2,deny,status:403,log,msg:'XSS via Data URI Detected',severity:CRITICAL,tag:'attack-xss'"

# Block XSS in event handlers
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(on(load|error|click|mouse|focus|blur|change|submit)=)" \
    "id:9003,phase:2,deny,status:403,log,msg:'XSS Event Handler Detected',severity:CRITICAL,tag:'attack-xss'"

# ===== SQL Injection Protection =====
# Block common SQL injection patterns
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(union.*select|insert.*into|delete.*from|drop.*table|drop.*database|exec.*\(|execute.*\()" \
    "id:9010,phase:2,deny,status:403,log,msg:'SQL Injection Attack Detected',severity:CRITICAL,tag:'attack-sqli'"

# Block SQL comments and tricks
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(--|;|/\*|\*/|'.*or.*'.*=.*'|'.*or.*1.*=.*1)" \
    "id:9011,phase:2,deny,status:403,log,msg:'SQL Injection Comment/Trick Detected',severity:CRITICAL,tag:'attack-sqli'"

# Block SQL authentication bypass
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)('.*or.*'|admin'.*--|'.*=.*')" \
    "id:9012,phase:2,deny,status:403,log,msg:'SQL Authentication Bypass Detected',severity:CRITICAL,tag:'attack-sqli'"

# ===== Path Traversal Protection =====
# Block directory traversal attempts
SecRule REQUEST_URI|ARGS "@rx (?i)(\.\./|\.\.\\|/etc/passwd|/etc/shadow|/etc/hosts|\\windows\\|c:\\)" \
    "id:9020,phase:2,deny,status:403,log,msg:'Path Traversal Attack Detected',severity:CRITICAL,tag:'attack-lfi'"

# Block encoded path traversal
SecRule REQUEST_URI|ARGS "@rx (?i)(%2e%2e/|%2e%2e%5c|%252e%252e)" \
    "id:9021,phase:2,deny,status:403,log,msg:'Encoded Path Traversal Detected',severity:CRITICAL,tag:'attack-lfi'"

# ===== Command Injection Protection =====
# Block shell command injection
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(;.*whoami|;.*cat|;.*ls|;.*id|;.*pwd|\$\(|\`|&&|\|\|)" \
    "id:9030,phase:2,deny,status:403,log,msg:'Command Injection Attack Detected',severity:CRITICAL,tag:'attack-rce'"

# Block command execution functions
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(exec\(|system\(|passthru\(|shell_exec\(|popen\()" \
    "id:9031,phase:2,deny,status:403,log,msg:'Command Execution Function Detected',severity:CRITICAL,tag:'attack-rce'"

# ===== Remote File Inclusion (RFI) Protection =====
# Block external URL inclusion
SecRule ARGS "@rx (?i)(https?://|ftp://|file://)" \
    "id:9040,phase:2,deny,status:403,log,msg:'Remote File Inclusion Detected',severity:HIGH,tag:'attack-rfi'"

# ===== Server-Side Template Injection (SSTI) Protection =====
# Block template injection patterns
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(\{\{.*\}\}|\{%.*%\}|<%.*%>)" \
    "id:9050,phase:2,deny,status:403,log,msg:'Server-Side Template Injection Detected',severity:HIGH,tag:'attack-ssti'"

# ===== LDAP Injection Protection =====
# Block LDAP injection attempts
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(\(\||\*\)|\)\()" \
    "id:9060,phase:2,deny,status:403,log,msg:'LDAP Injection Detected',severity:HIGH,tag:'attack-ldap'"

# ===== XML/XXE Protection =====
# Block XXE entity declarations
SecRule REQUEST_BODY "@rx (?i)(<!ENTITY|<!DOCTYPE.*\[)" \
    "id:9070,phase:2,deny,status:403,log,msg:'XXE Attack Detected',severity:HIGH,tag:'attack-xxe'"

# ===== NoSQL Injection Protection =====
# Block NoSQL injection patterns (MongoDB)
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(\$ne|\$gt|\$lt|\$where|\$regex)" \
    "id:9080,phase:2,deny,status:403,log,msg:'NoSQL Injection Detected',severity:HIGH,tag:'attack-nosql'"

# ===== Dashboard Specific Protection =====
# Block unauthorized API access attempts
SecRule REQUEST_URI "@rx (?i)/api/(users|admin|config|secrets)" \
    "id:9100,phase:1,deny,status:403,log,msg:'Unauthorized API Access Attempt',severity:HIGH,tag:'dashboard-protection',chain"
    SecRule REMOTE_ADDR "!@ipMatch 127.0.0.1,::1,100.64.0.0/10,192.168.216.0/24,172.16.216.0/24"

# Block brute force login attempts
SecRule REQUEST_URI "@rx (?i)/api/auth/login" \
    "id:9101,phase:2,log,msg:'Login Attempt Detected',severity:NOTICE,tag:'dashboard-monitoring'"

# Block scanner user agents
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(nikto|sqlmap|nmap|masscan|dirbuster|gobuster|wpscan|acunetix)" \
    "id:9110,phase:1,deny,status:403,log,msg:'Security Scanner Detected',severity:HIGH,tag:'attack-scanner'"

# ===== Finance Application Protection =====
# Block unauthorized access to sensitive finance endpoints
SecRule REQUEST_URI "@rx (?i)/finance/(admin|config|internal)" \
    "id:9200,phase:1,deny,status:403,log,msg:'Unauthorized Finance Endpoint Access',severity:HIGH,tag:'finance-protection'"

# Validate financial transaction amounts (prevent negative amounts or excessive values)
SecRule ARGS:amount "@rx ^-|^[0-9]{10,}$" \
    "id:9201,phase:2,deny,status:400,log,msg:'Invalid Transaction Amount',severity:MEDIUM,tag:'finance-validation'"

# ===== Industrial Application Protection =====
# Block unauthorized access to industrial control endpoints
SecRule REQUEST_URI "@rx (?i)/industrial/(control|scada|plc|settings)" \
    "id:9300,phase:1,deny,status:403,log,msg:'Unauthorized Industrial Control Access',severity:CRITICAL,tag:'industrial-protection'"

# Block dangerous SCADA commands
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(shutdown|restart|emergency_stop|override)" \
    "id:9301,phase:2,deny,status:403,log,msg:'Dangerous Industrial Command Detected',severity:CRITICAL,tag:'industrial-protection'"

# ===== Rate Limiting Preparation =====
# Mark high-risk requests for rate limiting by Custom WAF Layer 2
SecRule REQUEST_URI "@rx (?i)/(login|register|password-reset|api/auth)" \
    "id:9400,phase:1,pass,log,msg:'Rate Limit Candidate',severity:NOTICE,tag:'rate-limit-marker',setvar:tx.rate_limit_flag=1"

# ===== Common Attack Patterns =====
# Block null byte injection
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx \x00" \
    "id:9500,phase:2,deny,status:403,log,msg:'Null Byte Injection Detected',severity:HIGH,tag:'attack-evasion'"

# Block HTTP response splitting
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS "@rx (?i)(%0d%0a|\r\n)" \
    "id:9501,phase:2,deny,status:403,log,msg:'HTTP Response Splitting Detected',severity:HIGH,tag:'attack-splitting'"

# Block CRLF injection
SecRule REQUEST_URI|ARGS "@rx (?:%0[ad]|\\r|\\n)" \
    "id:9502,phase:2,deny,status:403,log,msg:'CRLF Injection Detected',severity:HIGH,tag:'attack-injection'"

# ===== Information Disclosure Prevention =====
# Block attempts to access sensitive files
SecRule REQUEST_URI "@rx (?i)\.(env|git|svn|htaccess|htpasswd|sql|bak|backup|log|conf|config|ini)$" \
    "id:9600,phase:1,deny,status:403,log,msg:'Sensitive File Access Attempt',severity:HIGH,tag:'info-disclosure'"

# Block directory listing attempts
SecRule REQUEST_URI "@rx (?i)/(\.\.;|\.\.%00)" \
    "id:9601,phase:1,deny,status:403,log,msg:'Directory Listing Attempt',severity:MEDIUM,tag:'info-disclosure'"
