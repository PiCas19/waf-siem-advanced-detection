# ==============================================================================
# Caddy Configuration - Dual-Layer WAF
# ==============================================================================

{
    email pierpaolo.casati@student.supsi.ch
    auto_https off

    # WAF execution order
    order coraza_waf first
    order waf before reverse_proxy

    servers {
        protocols h1 h2 h3
        timeouts {
            read_body 10s
            read_header 5s
            write 30s
            idle 2m
        }
    }
}

# ==============================================================================
# Snippets - Reusable Configuration Blocks
# ==============================================================================

(coraza_layer) {
    coraza_waf {
        directives `
            Include /etc/caddy/waf/coraza.conf
        `
    }
}

(waf_wan) {
    waf {
        log_file /var/log/caddy/waf_wan.log
        block_mode true
        api_endpoint http://localhost:8081/api
        rules_endpoint http://localhost:8081/api/waf/custom-rules
        blocklist_endpoint http://localhost:8081/api/waf/blocklist
        whitelist_endpoint http://localhost:8081/api/waf/whitelist
        enable_tailscale_detection false
        enable_dmz_detection true
        dmz_networks 172.16.216.0/24
        trusted_proxies 127.0.0.1 ::1
    }
}

(waf_wan_full) {
    waf {
        log_file /var/log/caddy/waf_wan.log
        block_mode true
        api_endpoint http://localhost:8081/api
        rules_endpoint http://localhost:8081/api/waf/custom-rules
        blocklist_endpoint http://localhost:8081/api/waf/blocklist
        whitelist_endpoint http://localhost:8081/api/waf/whitelist
        enable_hmac_signature_validation true
        hmac_shared_secret "change-this-to-your-production-secret-key-minimum-32-characters"
        enable_tailscale_detection true
        tailscale_networks 100.64.0.0/10
        enable_dmz_detection true
        dmz_networks 172.16.216.0/24
        trusted_proxies 127.0.0.1 ::1 100.64.0.0/10
    }
}

(waf_lan) {
    waf {
        log_file /var/log/caddy/waf_lan.log
        block_mode true
        api_endpoint http://localhost:8081/api
        rules_endpoint http://localhost:8081/api/waf/custom-rules
        enable_dmz_detection true
        dmz_networks 172.16.216.0/24
        trusted_proxies 127.0.0.1 ::1 192.168.216.0/24 172.16.216.0/24
    }
}

(reverse_proxy_config) {
    health_uri /health
    health_interval 10s
    health_timeout 2s
    header_up X-Forwarded-For {remote_host}
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-Proto {scheme}
    transport http {
        read_timeout 30s
        write_timeout 30s
        dial_timeout 2s
        keepalive 30s
    }
}

(tls_config) {
    protocols tls1.2 tls1.3
    ciphers TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 \
            TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 \
            TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 \
            TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
}

# ==============================================================================
# WAN - Port 9443 (HTTPS) - Finance & Industrial Only
# ==============================================================================

:9443 {
    bind 172.16.216.10
    tls /etc/caddy/certs/cert.pem /etc/caddy/certs/privkey.pem {
        import tls_config
    }

    # Finance Application
    handle /finance* {
        import coraza_layer
        import waf_wan

        uri strip_prefix /finance
        reverse_proxy 172.16.216.30:3000 {
            import reverse_proxy_config
        }
    }

    # Industrial Application
    handle /industrial* {
        import coraza_layer
        import waf_wan

        uri strip_prefix /industrial
        reverse_proxy 172.16.216.20:3001 {
            import reverse_proxy_config
        }
    }

    # Block everything else
    handle {
        respond "Not Found" 404
    }

    # Logging
    log {
        output file /var/log/caddy/access_wan.log
        format json
    }
}

# ==============================================================================
# LAN - Port 8080 (HTTP) - Full Dashboard Access
# ==============================================================================

:8080 {
    bind 0.0.0.0

    # WebSocket
    handle /ws {
        reverse_proxy {
            lb_policy least_conn
            health_uri /health
            health_interval 10s
            health_timeout 2s
            to 127.0.0.1:8081 127.0.0.1:8082 127.0.0.1:8083
            header_up Connection "Upgrade"
            header_up Upgrade "websocket"
            transport http {
                read_timeout 0s
                write_timeout 0s
                dial_timeout 2s
                keepalive 30s
            }
        }
    }

    # API
    handle /api* {
        reverse_proxy {
            lb_policy least_conn
            health_uri /health
            health_interval 10s
            health_timeout 2s
            to 127.0.0.1:8081 127.0.0.1:8082 127.0.0.1:8083
            transport http {
                read_timeout 30s
                write_timeout 30s
                dial_timeout 2s
                keepalive 30s
            }
        }
    }

    # Static Files
    handle /assets/* {
        root * /var/www/html
        file_server
        header Cache-Control "public, max-age=31536000"
    }

    handle /favicon.ico {
        root * /var/www/html
        file_server
    }

    handle /manifest.json {
        root * /var/www/html
        file_server
    }

    handle /robots.txt {
        root * /var/www/html
        file_server
    }

    handle /vite.svg {
        root * /var/www/html
        file_server
    }

    # SPA Routing with WAF
    handle {
        import coraza_layer
        import waf_wan_full

        root * /var/www/html
        try_files {path} /index.html
        file_server
        encode gzip zstd
    }

    # Logging
    log {
        output file /var/log/caddy/access_lan_http.log
        format json
    }
}

# ==============================================================================
# LAN - Port 8443 (HTTPS) - Full Dashboard Access
# ==============================================================================

:8443 {
    bind 0.0.0.0
    tls /etc/caddy/certs/cert.pem /etc/caddy/certs/privkey.pem

    # WebSocket
    handle /ws {
        reverse_proxy {
            lb_policy least_conn
            health_uri /health
            health_interval 10s
            health_timeout 2s
            to 127.0.0.1:8081 127.0.0.1:8082 127.0.0.1:8083
            header_up Connection "Upgrade"
            header_up Upgrade "websocket"
            transport http {
                read_timeout 0s
                write_timeout 0s
                dial_timeout 2s
                keepalive 30s
            }
            header_up X-Forwarded-For {http.request.remote}
            header_up X-Forwarded-Proto {http.request.proto}
            header_up X-Real-IP {http.request.remote}
        }
    }

    # API
    handle /api* {
        reverse_proxy {
            lb_policy least_conn
            health_uri /health
            health_interval 10s
            health_timeout 2s
            to 127.0.0.1:8081 127.0.0.1:8082 127.0.0.1:8083
            transport http {
                read_timeout 30s
                write_timeout 30s
                dial_timeout 2s
                keepalive 30s
            }
            trusted_proxies 127.0.0.1 ::1
        }
    }

    # Static Files
    handle /assets/* {
        root * /var/www/html
        file_server
        header Cache-Control "public, max-age=31536000"
    }

    handle /favicon.ico {
        root * /var/www/html
        file_server
    }

    handle /manifest.json {
        root * /var/www/html
        file_server
    }

    handle /robots.txt {
        root * /var/www/html
        file_server
    }

    handle /vite.svg {
        root * /var/www/html
        file_server
    }

    # SPA Routing with WAF
    handle {
        import coraza_layer
        import waf_lan

        root * /var/www/html
        try_files {path} /index.html
        file_server
        encode gzip zstd
    }

    # Logging
    log {
        output file /var/log/caddy/access_lan_https.log
        format json
    }
}

# ==============================================================================
# LAN - HTTP on IP:80 - Full Dashboard Access
# ==============================================================================

http://172.16.216.10 {
    # WebSocket
    handle /ws {
        reverse_proxy {
            lb_policy least_conn
            health_uri /health
            health_interval 10s
            health_timeout 2s
            to 127.0.0.1:8081 127.0.0.1:8082 127.0.0.1:8083
            header_up Connection "Upgrade"
            header_up Upgrade "websocket"
            transport http {
                read_timeout 0s
                write_timeout 0s
                dial_timeout 2s
                keepalive 30s
            }
            trusted_proxies 127.0.0.1 ::1
        }
    }

    # API
    handle /api* {
        reverse_proxy {
            lb_policy least_conn
            health_uri /health
            health_interval 10s
            health_timeout 2s
            to 127.0.0.1:8081 127.0.0.1:8082 127.0.0.1:8083
            transport http {
                read_timeout 30s
                write_timeout 30s
                dial_timeout 2s
                keepalive 30s
            }
            trusted_proxies 127.0.0.1 ::1
        }
    }

    # Static Files
    handle /assets/* {
        root * /var/www/html
        file_server
        header Cache-Control "public, max-age=31536000"
    }

    handle /favicon.ico {
        root * /var/www/html
        file_server
    }

    handle /manifest.json {
        root * /var/www/html
        file_server
    }

    handle /robots.txt {
        root * /var/www/html
        file_server
    }

    handle /vite.svg {
        root * /var/www/html
        file_server
    }

    # SPA Routing with WAF
    handle {
        import coraza_layer
        import waf_lan

        root * /var/www/html
        try_files {path} /index.html
        file_server
        encode gzip zstd
    }

    # Logging
    log {
        output file /var/log/caddy/access_lan_http.log
        format json
    }
}
